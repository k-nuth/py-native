# Copyright (c) 2016-2022 Knuth Project developers.
# Distributed under the MIT software license, see the accompanying
# file COPYING or http://www.opensource.org/licenses/mit-license.php.

branches:
  only:
  - master
  - dev

linux: &linux
   os: linux
   sudo: required
   language: python
  #  python: "3.6"
   services:
     - docker

osx: &osx
   os: osx
   sudo: required
   # language: python
   # python: "3.6"
   language: generic



#   2.7.12
#   2.7.13
#   3.4.0
#   3.4-dev
#   3.4.1
#   3.4.2
#   3.4.3
#   3.4.4
#   3.4.5
#   3.4.6
#   3.4.7
#   3.5.0
#   3.5-dev
#   3.5.1
#   3.5.2
#   3.5.3
#   3.5.4
#   3.6.0
#   3.6-dev
#   3.6.1
#   3.6.2
#   3.7-dev


matrix:
   include:
      - <<: *linux
        env: PUSH_TO_REPOS=true

      - <<: *linux
        env: C_COMPILER=gcc-6 CXX_COMPILER=g++-6
        compiler: gcc
        python: "2.7"
      - <<: *linux
        env: C_COMPILER=gcc-6 CXX_COMPILER=g++-6
        compiler: gcc
        python: "3.6"
      # - <<: *linux
      #   env: C_COMPILER=gcc-6 CXX_COMPILER=g++-6
      #   compiler: gcc
      #   python: "3.7"

      # - <<: *osx
      #   osx_image: xcode7.3
      #   env: CONAN_APPLE_CLANG_VERSIONS=7.3  TRAVIS_PYTHON_VERSION=2.7 PYTHON_FULL_VERSION=2.7.13
      #   python: "2.7"

      # - <<: *osx
      #   osx_image: xcode8.3
      #   env: CONAN_APPLE_CLANG_VERSIONS=8.1 TRAVIS_PYTHON_VERSION=2.7 PYTHON_FULL_VERSION=2.7.13
      #   python: "2.7"

      # - <<: *osx
      #   osx_image: xcode7.3
      #   env: CONAN_APPLE_CLANG_VERSIONS=7.3 TRAVIS_PYTHON_VERSION=3.4 PYTHON_FULL_VERSION=3.4.2
      #   # PYTHON_FULL_VERSION=3.4.7
      #   python: "3.4"

      # - <<: *osx
      #   osx_image: xcode8.3
      #   env: CONAN_APPLE_CLANG_VERSIONS=8.1 TRAVIS_PYTHON_VERSION=3.4 PYTHON_FULL_VERSION=3.4.2
      #   python: "3.4"

      # - <<: *osx
      #   osx_image: xcode7.3
      #   env: CONAN_APPLE_CLANG_VERSIONS=7.3 TRAVIS_PYTHON_VERSION=3.5 PYTHON_FULL_VERSION=3.5.2
      #   # PYTHON_FULL_VERSION=3.5.4
      #   python: "3.5"

      # - <<: *osx
      #   osx_image: xcode8.3
      #   env: CONAN_APPLE_CLANG_VERSIONS=8.1 TRAVIS_PYTHON_VERSION=3.5 PYTHON_FULL_VERSION=3.5.2
      #   python: "3.5"

      # - <<: *osx
      #   osx_image: xcode7.3
      #   env: CONAN_APPLE_CLANG_VERSIONS=7.3 TRAVIS_PYTHON_VERSION=3.6 PYTHON_FULL_VERSION=3.6.2
      #   python: "3.6"

      # - <<: *osx
      #   osx_image: xcode8.3
      #   env: CONAN_APPLE_CLANG_VERSIONS=8.1 TRAVIS_PYTHON_VERSION=3.6 PYTHON_FULL_VERSION=3.6.2
      #   python: "3.6"




      - <<: *osx
        osx_image: xcode9.3
        env: CONAN_APPLE_CLANG_VERSIONS=9.1 TRAVIS_PYTHON_VERSION=2.7 PYTHON_FULL_VERSION=2.7.13
        python: "2.7"
      - <<: *osx
        osx_image: xcode9.3
        env: CONAN_APPLE_CLANG_VERSIONS=9.1 TRAVIS_PYTHON_VERSION=3.5 PYTHON_FULL_VERSION=3.5.2
        python: "3.5"
      - <<: *osx
        osx_image: xcode9.3
        env: CONAN_APPLE_CLANG_VERSIONS=9.1 TRAVIS_PYTHON_VERSION=3.6 PYTHON_FULL_VERSION=3.6.2
        python: "3.6"
      # - <<: *osx
      #   osx_image: xcode9.3
      #   env: CONAN_APPLE_CLANG_VERSIONS=9.1 TRAVIS_PYTHON_VERSION=3.7 PYTHON_FULL_VERSION=3.7.0
      #   python: "3.7"


install:

  - set -e
  # - set -x
  - |
    if [[ "${PUSH_TO_REPOS}" != "true" ]]; then
      if [[ "${TRAVIS_OS_NAME}" != "linux" ]]; then
        brew update || brew update
        brew outdated pyenv || brew upgrade pyenv
        brew install pyenv-virtualenv
        brew install cmake || true

        if which pyenv > /dev/null; then
            eval "$(pyenv init -)"
            eval "$(pyenv virtualenv-init -)"
        fi

        pyenv install --list
        pyenv install $PYTHON_FULL_VERSION
        pyenv virtualenv $PYTHON_FULL_VERSION conan

        pyenv rehash
        pyenv activate conan

        # sudo pip install --upgrade pip
        # pip install --upgrade pip --user
        pip install --upgrade pip
        pip install cryptography --global-option=build_ext --global-option="-L/usr/local/opt/openssl/lib" --global-option="-I/usr/local/opt/openssl/include"
      else
        pip install --upgrade pip
      fi

      pip install conan_package_tools --upgrade
      pip install conan --upgrade
      pip install wheel --upgrade
      pip install twine --upgrade
      conan user
    fi



script:

  - set -e

  - git fetch --unshallow || true
  - export BITPRIM_BUILD_NUMBER="$(git describe)"
  - echo "${BITPRIM_BUILD_NUMBER}"

  - |
    if [[ "${PUSH_TO_REPOS}" == "true" ]]; then
      chmod +x .travis/push_other_repo.sh
      ./.travis/push_other_repo.sh
    else
      if [[ "${TRAVIS_OS_NAME}" != "linux" ]]; then
        if which pyenv > /dev/null; then
            eval "$(pyenv init -)"
            eval "$(pyenv virtualenv-init -)"
        fi
        pyenv activate conan
      fi

      if [[ "${TRAVIS_OS_NAME}" == "linux" ]]; then
        cd ${TRAVIS_BUILD_DIR}
        chmod a+x .travis/entrypoint.sh
        /usr/bin/docker run --rm -ti -e TRAVIS_PYTHON_VERSION=$TRAVIS_PYTHON_VERSION -v ${TRAVIS_BUILD_DIR}:/home/conan/project -v ${TRAVIS_BUILD_DIR}/.travis/entrypoint.sh:/tmp/entrypoint.sh lasote/conangcc63 /bin/bash -c /tmp/entrypoint.sh
      else
        python --version
        conan user
        conan remote add kth_temp https://knuth.jfrog.io/artifactory/api/conan/knuth
        conan install .
        pip install  -e .
        python setup.py sdist
        python setup.py bdist_wheel
      fi

      # - python setup.py sdist

      # TestPyPI ... https://packaging.python.org/guides/using-testpypi/
      if [[ "${TRAVIS_BRANCH}" == "master" ]]; then
        twine upload -u ${PYPI_USER_NAME} -p ${PYPI_PASSWORD} dist/* || true
      else
        # For Testing Release
        # twine upload -r test -u ${PYPI_USER_NAME} -p ${PYPI_PASSWORD} dist/* || true
        twine upload -u ${PYPI_USER_NAME} -p ${PYPI_PASSWORD} --repository-url https://test.pypi.org/legacy/ dist/*  || true
      fi
    fi


notifications:
  email:
    - info@kth.cash
